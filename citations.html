<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extracteur de Citations Spirituelles (avec IA)</title>
    <style>
        :root {
            --primary: #764ba2;
            --secondary: #667eea;
            --accent: #ff9a9e;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --text-main: #2d3436;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--text-main);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 40px;
            font-size: 3em;
            font-weight: 800;
            background: linear-gradient(to right, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .upload-section {
            background: rgba(102, 126, 234, 0.05);
            border: 3px dashed var(--secondary);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            margin-bottom: 40px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .upload-section:hover {
            border-color: var(--primary);
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-5px);
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 45px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
            transition: all 0.3s;
        }

        .file-label:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(118, 75, 162, 0.4);
        }

        .file-name {
            margin-top: 15px;
            color: #666;
            font-style: italic;
        }

        .options-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .option-group {
            margin-bottom: 0;
        }

        .option-group.full-width {
            grid-column: span 2;
        }

        .option-group label {
            display: block;
            margin-bottom: 12px;
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="number"] {
            padding: 15px 25px;
            border: 2px solid #eee;
            border-radius: 15px;
            width: 100%;
            font-size: 1em;
            transition: all 0.3s;
            outline: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f0f4f8;
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .checkbox-container:hover {
            background: #e2e8f0;
        }

        input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 60px;
            border-radius: 50px;
            font-size: 1.25em;
            font-weight: 700;
            cursor: pointer;
            display: block;
            margin: 30px auto;
            box-shadow: 0 10px 25px rgba(118, 75, 162, 0.3);
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(118, 75, 162, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .citations-container {
            margin-top: 40px;
        }

        .citation {
            background: white;
            border-left: 8px solid var(--primary);
            padding: 35px;
            margin-bottom: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
            animation: fadeIn 0.5s ease-in;
        }

        .citation:hover {
            transform: scale(1.02);
        }

        .citation::before {
            content: '‚Äú';
            position: absolute;
            top: 10px;
            left: 15px;
            font-size: 5em;
            color: rgba(118, 75, 162, 0.05);
            font-family: serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .citation-text {
            font-size: 1.3em;
            line-height: 1.7;
            color: #2d3436;
            margin-bottom: 20px;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .citation-context {
            font-size: 0.9em;
            color: #888;
            border-top: 1px solid #f0f0f0;
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .error {
            background: #fff5f5;
            color: #d63031;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #fab1a0;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        .info {
            background: #edf2ff;
            color: #4c6ef5;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        .ai-badge {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-indicator {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .search-mode-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .mode-btn {
            flex: 1;
            max-width: 250px;
            cursor: pointer;
        }

        .mode-btn input[type="radio"] {
            display: none;
        }

        .mode-content {
            background: white;
            padding: 15px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #eee;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .mode-btn input[type="radio"]:checked+.mode-content {
            border-color: var(--primary);
            background: rgba(118, 75, 162, 0.05);
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.1);
        }

        .mode-icon {
            font-size: 1.8em;
        }

        .mode-text {
            font-weight: 700;
            color: #555;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-btn input[type="radio"]:checked+.mode-content .mode-text {
            color: var(--primary);
        }

        @media (max-width: 600px) {
            .search-mode-selector {
                flex-direction: column;
                align-items: center;
            }

            .mode-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìñ Extracteur de Citations Spirituelles</h1>

        <div class="search-mode-selector">
            <label class="mode-btn">
                <input type="radio" name="searchMode" id="modeLocal" checked>
                <div class="mode-content">
                    <span class="mode-icon">üíæ</span>
                    <span class="mode-text">Fichier Local</span>
                </div>
            </label>
            <label class="mode-btn">
                <input type="radio" name="searchMode" id="modeOnline">
                <div class="mode-content">
                    <span class="mode-icon">üåê</span>
                    <span class="mode-text">Biblioth√®que Online</span>
                </div>
            </label>
        </div>

        <div id="localSection">
            <div class="upload-section">
                <label for="fileInput" class="file-label">
                    S√©lectionner un fichier (PDF, TXT ou JSON)
                </label>
                <input type="file" id="fileInput" accept=".pdf,.txt,.epub,.json">
                <div class="file-name" id="fileName">Aucun fichier s√©lectionn√©</div>
            </div>
        </div>

        <div id="onlineSection" style="display: none;">
            <div class="info">
                La recherche s'effectuera parmi les centaines de livres de la biblioth√®que GitHub.
                <br><small>(Bas√© sur votre index_master.json)</small>
            </div>
        </div>

        <div class="options-section">
            <div class="option-group full-width">
                <label for="keywordInput">Th√®me ou mot-cl√© pour chercher un paradoxe (optionnel) :</label>
                <input type="text" id="keywordInput" placeholder="Ex: lumi√®re, foi, silence, mort...">
            </div>

            <div class="option-group">
                <label for="numCitations">Quantit√© de citations :</label>
                <input type="number" id="numCitations" value="5" min="1" max="20">
            </div>

            <div class="option-group">
                <label>&nbsp;</label>
                <label for="useAI" class="checkbox-container">
                    <input type="checkbox" id="useAI" checked>
                    <span>Utiliser l'IA <span class="ai-badge">Premium</span></span>
                </label>
            </div>
        </div>

        <button id="extractBtn" disabled>Extraire Citations</button>

        <div id="messageContainer"></div>
        <div id="citationsContainer" class="citations-container"></div>
    </div>

    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // Configuration PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;
        }

        // Configuration du proxy HuggingFace
        const PROXY_URL = "https://gildasr-dictionnaires.hf.space/api/chat";

        // Mod√®les OpenRouter : S√©lection des mod√®les gratuits les plus puissants (Llama 70B/405B, etc.)
        const OPENROUTER_MODELS = [
            "meta-llama/llama-3.3-70b-instruct:free",
            "meta-llama/llama-3.1-405b-instruct:free",
            "mistralai/mistral-small-3.1-24b-instruct:free",
            "google/gemini-2.0-pro-exp-02-05:free",
            "openai/gpt-oss-120b:free",
            "tngtech/deepseek-r1t-chimera:free",
            "anthropic/claude-3-haiku"
        ];

        const DELAY_BETWEEN_MODELS = 3000;  // 3 secondes
        const DELAY_AFTER_ERROR = 5000;     // 5 secondes
        const API_TIMEOUT = 60000;          // 60 secondes
        const MAX_ATTEMPTS_PER_BOOK = 12;

        // Vocabulaire religieux pour d√©tection
        const vocabulaireReligieux = [
            // Noms divins et figures sacr√©es
            'dieu', 'seigneur', 'christ', 'j√©sus', 'esprit', 'saint', 'trinit√©',
            'allah', 'proph√®te', 'muhammad', 'mahomet', 'marie', 'vierge',

            // Concepts th√©ologiques fondamentaux
            'divin', 'sacr√©', '√©ternel', 'transcendance', 'immanence', 'providence',
            'gr√¢ce', 'mis√©ricorde', 'r√©demption', 'salut', 'incarnation', 'r√©surrection',

            // Dimension int√©rieure et mystique
            '√¢me', 'esprit', 'c≈ìur', 'conscience', 'int√©riorit√©', 'mystique',
            'contempl', 'm√©ditation', 'oraison', 'recueillement', 'silence',
            'illumination', 'r√©v√©lation', 'extase', 'union', 'th√©osis', 'd√©ification',

            // Vertus et √©tats spirituels
            'foi', 'esp√©rance', 'charit√©', 'amour', 'humilit√©', 'ob√©issance',
            'pauvret√©', 'd√©tachement', 'abandon', 'confiance', 'patience',
            'sagesse', 'discernement', 'puret√©', 'simplicit√©',

            // Pratiques et voies
            'pri√®re', 'je√ªne', 'asc√®se', 'p√©nitence', 'pardon', 'confession',
            'communion', 'eucharistie', 'sacrement', 'bapt√™me',
            'ramadan', 'hajj', 'p√®lerinage', 'dhikr', 'soufisme',

            // Chute et r√©demption
            'p√©ch√©', 'chute', 'tentation', '√©preuve', 'purification', 'conversion',
            'repentir', 'p√©nitent', 'rachat', 'expiation',

            // R√©alit√©s eschatologiques
            'paradis', 'ciel', 'enfer', 'purgatoire', 'jugement', '√©ternit√©',
            'royaume', 'vie √©ternelle', 'r√©surrection', 'gloire',

            // Textes et traditions
            '√©vangile', '√©criture', 'parole', 'testament', 'bible',
            'coran', 'sourate', 'verset', 'hadith', 'sunna', 'tradition',

            // Lieux et communaut√©s
            '√©glise', 'temple', 'cath√©drale', 'monast√®re', 'ermitage',
            'mosqu√©e', 'mecque', 'm√©dine', 'j√©rusalem',
            'communaut√©', 'fid√®le', 'croyant', 'disciple', 'fr√®re', 's≈ìur',

            // Symboles et rituels
            'croix', 'crucifixion', 'passion', 'sang', 'pain', 'vin',
            'lumi√®re', 't√©n√®bres', 'eau', 'feu', 'souffle', 'voile',
            'rosaire', 'chapelet', 'ic√¥ne', 'relique',

            // Paradoxes mystiques classiques
            'mort', 'vie', 'vide', 'plein', 'nuit', 'jour',
            'an√©antissement', '√™tre', 'n√©ant', 'tout', 'rien',
            'pauvre', 'riche', 'petit', 'grand', 'dernier', 'premier',
            'serviteur', 'ma√Ætre', 'esclave', 'libre',

            // Voie mystique
            'nuit obscure', 'd√©sert', 'aridit√©', 'consolation', 'd√©solation',
            'qui√©tude', 'passivit√©', 'activit√©', 'effort', 'don',
            'volont√©', 'abandon', 'renoncement', 'possession',

            // Termes soufis et mystiques musulmans
            'fana', 'baqa', 'tawhid', 'nafs', 'qalb', 'ruh',
            'maqam', 'hal', 'tariqa', 'soufi', 'derviche',

            // Termes mystiques chr√©tiens
            'th√©ologie n√©gative', 'apophatique', 'nu√©e', 't√©n√®bre divine',
            'h√©sychasme', 'qui√©tisme', 'abandon', 'petite voie',

            // Exp√©rience spirituelle
            'consolation', 's√©cheresse', 'aridit√©', 'ferveur',
            'vision', 'locution', 'stigmate', 'miracle', 'gr√¢ce',
            'onction', 'pr√©sence', 'absence', 'proximit√©', 'distance'
        ];

        let fileContent = '';
        let selectedFile = null;
        let pageIndex = [];
        let currentModelIndex = 0;

        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const extractBtn = document.getElementById('extractBtn');
        const citationsContainer = document.getElementById('citationsContainer');
        const messageContainer = document.getElementById('messageContainer');
        const keywordInput = document.getElementById('keywordInput');
        const numCitationsInput = document.getElementById('numCitations');
        const useAICheckbox = document.getElementById('useAI');
        const modeLocal = document.getElementById('modeLocal');
        const modeOnline = document.getElementById('modeOnline');
        const localSection = document.getElementById('localSection');
        const onlineSection = document.getElementById('onlineSection');

        // Gestion du changement de mode
        function updateMode() {
            if (modeLocal.checked) {
                localSection.style.display = 'block';
                onlineSection.style.display = 'none';
                extractBtn.disabled = !selectedFile;
            } else {
                localSection.style.display = 'none';
                onlineSection.style.display = 'block';
                extractBtn.disabled = false; // Toujours actif en mode en ligne (on v√©rifie le mot-cl√© au clic)
            }
        }

        modeLocal.addEventListener('change', updateMode);
        modeOnline.addEventListener('change', updateMode);

        fileInput.addEventListener('change', async (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                fileName.textContent = selectedFile.name;
                extractBtn.disabled = false;
                citationsContainer.innerHTML = '';
                messageContainer.innerHTML = '';
            }
        });

        // URL de base du repo GitHub
        // Structure attendue : 
        // - racine/index_master.json (le catalogue)
        // - racine/LIVRES/nom_du_livre.json (les livres)
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/dictionnaireS/livres/main';

        // Nom du fichier d'index global (catalogue)
        const CATALOG_FILENAME = 'LIVRES/index_master.json';

        extractBtn.addEventListener('click', async () => {
            citationsContainer.innerHTML = '';
            messageContainer.innerHTML = '';
            extractBtn.disabled = true;

            const keyword = keywordInput.value.trim();
            const numCitations = parseInt(numCitationsInput.value) || 5;
            const useAI = useAICheckbox.checked;

            try {
                let candidates = [];

                // --- MODE FICHIER LOCAL ---
                if (modeLocal.checked) {
                    if (!selectedFile) return;
                    showMessage('Lecture du fichier local...', 'loading');

                    let localSource = selectedFile.name;
                    if (selectedFile.name.toLowerCase().endsWith('.pdf')) {
                        fileContent = await extractTextFromPDF(selectedFile);
                    } else if (selectedFile.name.toLowerCase().endsWith('.txt')) {
                        fileContent = await extractTextFromTXT(selectedFile);
                    } else if (selectedFile.name.toLowerCase().endsWith('.epub')) {
                        fileContent = await extractTextFromEPUB(selectedFile);
                    } else if (selectedFile.name.toLowerCase().endsWith('.json')) {
                        const jsonData = await extractTextFromJSON(selectedFile);
                        fileContent = jsonData.text;
                        if (jsonData.title) {
                            localSource = jsonData.author ? `${jsonData.title} (${jsonData.author})` : jsonData.title;
                        }
                    }

                    if (!fileContent || fileContent.trim().length === 0) {
                        throw new Error("Le fichier semble vide.");
                    }

                    // Extraction locale classique
                    candidates = extractCitations(fileContent, keyword, useAI ? numCitations * 8 : numCitations);
                    candidates.forEach(c => c.source = localSource);
                }

                // --- MODE BIBLIOTH√àQUE EN LIGNE (GITHUB) ---
                else {
                    if (!keyword) {
                        throw new Error("En mode Biblioth√®que, un th√®me ou mot-cl√© est obligatoire pour s√©lectionner les livres.");
                    }
                    showMessage('üîç Recherche dans la Biblioth√®que Spirituelle...', 'loading');

                    // 1. Charger l'index global
                    const indexResponse = await fetch(`${GITHUB_BASE_URL}/${CATALOG_FILENAME}`);
                    if (!indexResponse.ok) {
                        if (indexResponse.status === 404) {
                            throw new Error(`Le fichier catalogue "${CATALOG_FILENAME}" est introuvable sur GitHub.`);
                        }
                        throw new Error("Impossible de charger l'index de la biblioth√®que (Erreur " + indexResponse.status + ")");
                    }
                    const libraryIndex = await indexResponse.json();

                    // 2. Trouver les meilleurs livres pour ce mot-cl√©
                    const topBooks = findBestBooks(libraryIndex, keyword, 10); // Top 10

                    if (topBooks.length === 0) {
                        throw new Error(`Aucun livre ne semble correspondre au th√®me "${keyword}".`);
                    }

                    // 3. S√©lectionner 3 livres au hasard parmi ce Top 10
                    const selectedBooks = selectRandomBooks(topBooks, 3);
                    showMessage(`üìö Livres s√©lectionn√©s : ${selectedBooks.map(b => b.titre).join(', ')}`, 'info');

                    // 4. T√©l√©charger et scanner ces 3 livres
                    for (const book of selectedBooks) {
                        showMessage(`T√©l√©chargement de "${book.titre}"...`, 'loading');
                        const bookResponse = await fetch(`${GITHUB_BASE_URL}/${book.fichier_source}`);
                        if (!bookResponse.ok) continue;

                        const bookData = await bookResponse.json();

                        // Adaptation au format : "texte_integral" ou "contenu"
                        let bookText = "";
                        if (bookData.texte_integral) {
                            bookText = bookData.texte_integral;
                        } else if (bookData.contenu) {
                            bookText = Array.isArray(bookData.contenu) ? bookData.contenu.join(' ') : bookData.contenu;
                        }

                        if (!bookText) {
                            console.warn(`Pas de texte trouv√© pour le livre: ${book.titre}`);
                            continue;
                        }

                        // On accumule les candidats de ce livre
                        const bookCandidates = extractCitations(bookText, keyword, numCitations * 3);
                        bookCandidates.forEach(c => c.source = `${book.titre} (${book.auteur})`);
                        candidates = candidates.concat(bookCandidates);
                    }
                }

                // --- TRAITEMENT COMMUN (IA ou SCORING) ---
                if (candidates.length === 0) {
                    showMessage('Aucune citation trouv√©e.', 'info');
                    extractBtn.disabled = false;
                    return;
                }

                // M√©langer les candidats pour ne pas privil√©gier le premier livre scann√©
                candidates.sort(() => Math.random() - 0.5);

                let finalCitations;
                if (useAI) {
                    // On envoie le top X √† l'IA (toutes sources confondues)
                    // On simule une "pageIndex" vide car on a perdu le lien page/livre pr√©cis pour l'instant
                    // (Am√©lioration future : garder la source de chaque citation)
                    finalCitations = await extractCitationsWithAIFromCandidates(candidates, keyword, numCitations);
                } else {
                    // Tri par score paradoxal purement algorithmique
                    candidates.sort((a, b) => b.score - a.score);
                    finalCitations = candidates.slice(0, numCitations);
                }

                displayCitations(finalCitations, useAI);

            } catch (error) {
                showMessage('Erreur : ' + error.message, 'error');
            } finally {
                extractBtn.disabled = false;
            }
        });

        async function extractCitationsWithAIFromCandidates(candidates, keyword, numCitations) {
            showMessage('ü§ñ Mode IA activ√© - Analyse transversale...', 'loading');

            // On garde les 40 meilleurs candidats pour ne pas saturer le prompt
            const topCandidates = candidates.slice(0, 40);
            return await runAIAnalysis(topCandidates, keyword, numCitations);
        }

        // Logique de s√©lection des livres
        function findBestBooks(indexData, keyword, limit) {
            // L'index peut √™tre soit un tableau direct, soit un objet { livres: [...] }
            // Adaptation pour votre format : "livres": [ ... ]
            const books = Array.isArray(indexData) ? indexData : (indexData.livres || []);

            if (!books || books.length === 0) {
                console.warn("Index vide ou mal format√©", indexData);
                return [];
            }

            const search = keyword.toLowerCase();

            const scores = books.map(book => {
                let score = 0;

                // Recherche dans le titre
                if (book.titre && book.titre.toLowerCase().includes(search)) score += 20;

                // Recherche dans l'auteur
                if (book.auteur && book.auteur.toLowerCase().includes(search)) score += 10;

                // Recherche dans les th√®mes
                if (book.themes && Array.isArray(book.themes)) {
                    if (book.themes.some(t => t.toLowerCase().includes(search))) score += 15;
                }

                // Recherche dans les mots-cl√©s (votre nouveau format : tableau de strings)
                if (book.mots_cles && Array.isArray(book.mots_cles)) {
                    // On peut chercher si l'un des mots cl√©s contient le terme recherch√©
                    const match = book.mots_cles.some(mc => mc.toLowerCase().includes(search));
                    if (match) score += 25; // Tr√®s pertinent
                }

                // Normalisation du chemin de fichier
                // Votre index utilise "fichier", le code utilisait "fichier_source"
                // On normalise tout vers "fichier_source" pour la suite du script
                let filePath = book.fichier || book.fichier_source;

                // On ajoute le pr√©fixe LIVRES si n√©cessaire
                if (filePath && !filePath.includes('/') && !filePath.includes('\\')) {
                    filePath = 'LIVRES/' + filePath;
                }

                return {
                    ...book,
                    relevance: score,
                    fichier_source: filePath
                };
            });

            return scores.filter(b => b.relevance > 0).sort((a, b) => b.relevance - a.relevance).slice(0, limit);
        }

        function selectRandomBooks(books, count) {
            const shuffled = [...books].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // Initialisation de l'affichage
        updateMode();


        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            let charCount = 0;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ') + '\n';

                pageIndex.push({
                    pageNumber: i,
                    startChar: charCount,
                    endChar: charCount + pageText.length
                });

                fullText += pageText;
                charCount += pageText.length;
            }

            return fullText;
        }

        async function extractTextFromTXT(file) {
            return await file.text();
        }

        async function extractTextFromEPUB(file) {
            const arrayBuffer = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer);
            let fullText = '';

            for (let filename in zip.files) {
                if (filename.match(/\.(html|xhtml|htm)$/i)) {
                    const content = await zip.files[filename].async('string');
                    const textOnly = content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ');
                    fullText += textOnly + '\n';
                }
            }

            return fullText;
        }

        async function extractTextFromJSON(file) {
            const text = await file.text();
            const data = JSON.parse(text);
            let content = "";
            if (data.texte_integral) content = data.texte_integral;
            else if (data.contenu) {
                content = Array.isArray(data.contenu) ? data.contenu.join(' ') : data.contenu;
            }
            return {
                text: content,
                title: data.titre || data.title,
                author: data.auteur || data.author
            };
        }

        function extractCitations(text, keyword = '', numCitations = 5) {
            const phraseRegex = /[^.!?]+[.!?]+/g;
            let match;
            const phrasesAvecPosition = [];

            while ((match = phraseRegex.exec(text)) !== null) {
                const phrase = match[0].trim();
                if (phrase.length > 50 && phrase.length < 500) {
                    phrasesAvecPosition.push({
                        phrase: phrase,
                        position: match.index
                    });
                }
            }

            let phrasesReligieuses = phrasesAvecPosition.filter(item => {
                const phraseLower = item.phrase.toLowerCase();
                return vocabulaireReligieux.some(mot => phraseLower.includes(mot));
            });

            if (keyword && keyword.length > 0) {
                const keywordLower = keyword.toLowerCase();
                const antonymes = getAntonyms(keywordLower);

                // On privil√©gie les phrases avec le keyword
                let keywordCandidates = phrasesReligieuses.filter(item => {
                    const phraseLower = item.phrase.toLowerCase();
                    return phraseLower.includes(keywordLower);
                });

                // Si on a des candidats avec le keyword, on cherche s'ils ont aussi un antonyme (paradoxe fort)
                if (keywordCandidates.length > 0) {
                    const paradoxCandidates = keywordCandidates.filter(item => {
                        const phraseLower = item.phrase.toLowerCase();
                        return antonymes.some(ant => phraseLower.includes(ant));
                    });

                    // Si on a des paradoxes explicites, on les utilise en priorit√©
                    if (paradoxCandidates.length > 0) {
                        phrasesReligieuses = paradoxCandidates;
                    } else {
                        // Sinon on garde les phrases avec le keyword, l'IA fera le tri
                        phrasesReligieuses = keywordCandidates;
                    }
                } else if (phrasesReligieuses.length > numCitations * 3) {
                    // Si on n'a rien avec le keyword mais beaucoup de religieux,
                    // on garde tout et on laisse le scoring paradoxal naturel agir
                }
            }

            if (phrasesReligieuses.length === 0) {
                showMessage('Aucune citation avec vocabulaire religieux trouv√©e.', 'info');
                return [];
            }

            const phrasesAvecScore = phrasesReligieuses.map(item => {
                const score = calculateParadoxScore(item.phrase, keyword);
                return {
                    phrase: item.phrase,
                    score: score,
                    position: item.position
                };
            });

            phrasesAvecScore.sort((a, b) => b.score - a.score);
            return phrasesAvecScore.slice(0, numCitations);
        }

        function calculateParadoxScore(phrase, keyword = '') {
            const phraseLower = phrase.toLowerCase();
            let score = 0;

            const motsParadoxaux = [
                // Lumi√®re et obscurit√©
                ['lumi√®re', 't√©n√®bres'], ['lumi√®re', 'obscurit√©'], ['lumi√®re', 'nuit'],
                ['jour', 'nuit'], ['clart√©', 'obscurit√©'], ['illumination', 'aveuglement'],
                ['voir', 'aveugle'], ['r√©v√©lation', 'voile'], ['d√©voiler', 'cacher'],

                // Vie et mort
                ['vie', 'mort'], ['vivre', 'mourir'], ['vivant', 'mort'],
                ['na√Ætre', 'mourir'], ['r√©surrection', 'mort'], ['renaissance', 'mort'],
                ['mortel', 'immortel'], ['p√©rissable', 'imp√©rissable'],

                // √ätre et n√©ant
                ['√™tre', 'n√©ant'], ['√™tre', 'non-√™tre'], ['existence', 'n√©ant'],
                ['tout', 'rien'], ['pl√©nitude', 'vide'], ['plein', 'vide'],
                ['pr√©sence', 'absence'], ['exister', 'an√©antir'],

                // Connaissance et ignorance
                ['savoir', 'ignorer'], ['connaissance', 'ignorance'], ['sagesse', 'folie'],
                ['connu', 'inconnu'], ['comprendre', 'incompr√©hensible'], ['certain', 'incertain'],
                ['science', 'ignorance'], ['r√©v√©ler', 'cacher'], ['manifeste', 'cach√©'],
                ['visible', 'invisible'], ['appara√Ætre', 'dispara√Ætre'], ['montrer', 'voiler'],

                // Foi et doute
                ['foi', 'doute'], ['croire', 'douter'], ['certitude', 'incertitude'],
                ['confiance', 'm√©fiance'], ['espoir', 'd√©sespoir'], ['esp√©rance', 'd√©sesp√©rance'],

                // Amour et haine
                ['amour', 'haine'], ['aimer', 'ha√Ør'], ['charit√©', '√©go√Øsme'],
                ['dilection', 'aversion'], ['attraction', 'r√©pulsion'],

                // Bien et mal
                ['bien', 'mal'], ['bon', 'mauvais'], ['vertu', 'vice'],
                ['juste', 'injuste'], ['justice', 'injustice'], ['saintet√©', 'p√©ch√©'],
                ['pur', 'impur'], ['puret√©', 'impuret√©'], ['innocent', 'coupable'],

                // Paix et guerre
                ['paix', 'guerre'], ['repos', 'combat'], ['calme', 'temp√™te'],
                ['tranquillit√©', 'trouble'], ['qui√©tude', 'agitation'], ['s√©r√©nit√©', 'tourment'],

                // Grandeur et petitesse
                ['grand', 'petit'], ['grandeur', 'petitesse'], ['immense', 'infime'],
                ['√©lev√©', 'bas'], ['haut', 'bas'], ['sublime', 'humble'],
                ['majest√©', 'humilit√©'], ['gloire', 'abaissement'],

                // Richesse et pauvret√© (paradoxe √©vang√©lique central)
                ['riche', 'pauvre'], ['richesse', 'pauvret√©'], ['poss√©der', 'd√©pouiller'],
                ['avoir', 'manquer'], ['abondance', 'd√©nuement'], ['plein', 'vide'],
                ['donner', 'recevoir'], ['perdre', 'gagner'], ['abandonner', 'garder'],

                // Force et faiblesse
                ['fort', 'faible'], ['force', 'faiblesse'], ['puissance', 'impuissance'],
                ['pouvoir', 'impuissance'], ['capable', 'incapable'], ['victorieux', 'vaincu'],

                // Libert√© et servitude
                ['libre', 'esclave'], ['libert√©', 'servitude'], ['lib√©rer', 'encha√Æner'],
                ['d√©livrer', 'captif'], ['autonomie', 'd√©pendance'], ['ind√©pendant', 'd√©pendant'],

                // Premier et dernier (paradoxe √©vang√©lique)
                ['premier', 'dernier'], ['commencer', 'finir'], ['d√©but', 'fin'],
                ['origine', 'terme'], ['alpha', 'om√©ga'], ['principe', 'fin'],

                // Ma√Ætre et serviteur
                ['ma√Ætre', 'serviteur'], ['ma√Ætre', 'esclave'], ['seigneur', 'serviteur'],
                ['commander', 'ob√©ir'], ['dominer', 'servir'], ['roi', 'esclave'],

                // Int√©rieur et ext√©rieur
                ['dedans', 'dehors'], ['int√©rieur', 'ext√©rieur'], ['intime', 'lointain'],
                ['proche', 'lointain'], ['proximit√©', 'distance'], ['cach√©', 'manifeste'],

                // Unit√© et multiplicit√©
                ['un', 'multiple'], ['unit√©', 'multiplicit√©'], ['unique', 'divers'],
                ['simple', 'compos√©'], ['simplicit√©', 'complexit√©'], ['indivisible', 'divisible'],

                // Parole et silence
                ['parole', 'silence'], ['parler', 'taire'], ['dire', 'silence'],
                ['verbe', 'silence'], ['exprimer', 'taire'], ['proclamer', 'cacher'],

                // Activit√© et passivit√© (mystique)
                ['agir', 'subir'], ['actif', 'passif'], ['action', 'passion'],
                ['faire', 'laisser'], ['effort', 'abandon'], ['volont√©', 'abandon'],
                ['travailler', 'reposer'], ['≈ìuvre', 'gr√¢ce'], ['m√©rite', 'don'],

                // Mouvement et repos
                ['mouvement', 'repos'], ['mobile', 'immobile'], ['marcher', 'demeurer'],
                ['aller', 'rester'], ['avancer', 'arr√™ter'], ['chercher', 'trouver'],
                ['errer', 'habiter'], ['exil', 'demeure'], ['voyage', 's√©jour'],

                // Temps et √©ternit√©
                ['temps', '√©ternit√©'], ['temporel', '√©ternel'], ['√©ph√©m√®re', '√©ternel'],
                ['passager', 'permanent'], ['transitoire', 'immuable'], ['changeant', 'immuable'],
                ['mortel', 'immortel'], ['corruptible', 'incorruptible'],

                // Terre et ciel
                ['terre', 'ciel'], ['terrestre', 'c√©leste'], ['bas', 'haut'],
                ['mat√©riel', 'spirituel'], ['corporel', 'spirituel'], ['chair', 'esprit'],
                ['charnel', 'spirituel'], ['monde', 'ciel'], ['s√©culier', 'sacr√©'],

                // Sacr√© et profane
                ['sacr√©', 'profane'], ['saint', 'profane'], ['divin', 'humain'],
                ['surnaturel', 'naturel'], ['gr√¢ce', 'nature'], ['transcendant', 'immanent'],

                // Soi et autre (mystique de l'union)
                ['soi', 'autre'], ['je', 'tu'], ['moi', 'toi'],
                ['propre', '√©tranger'], ['m√™me', 'autre'], ['identit√©', 'alt√©rit√©'],

                // V√©rit√© et erreur
                ['vrai', 'faux'], ['v√©rit√©', 'erreur'], ['v√©rit√©', 'mensonge'],
                ['authentique', 'illusoire'], ['r√©el', 'apparent'], ['√™tre', 'para√Ætre'],

                // Joie et tristesse
                ['joie', 'tristesse'], ['joie', 'douleur'], ['consolation', 'd√©solation'],
                ['all√©gresse', 'affliction'], ['bonheur', 'malheur'], ['b√©atitude', 'souffrance'],

                // Souffrance et gloire (k√©nose/passion)
                ['souffrance', 'gloire'], ['croix', 'gloire'], ['humiliation', 'exaltation'],
                ['abaissement', '√©l√©vation'], ['passion', 'r√©surrection'], ['mort', 'r√©surrection'],

                // Pl√©nitude et vide (mystique apophatique)
                ['pl√©nitude', 'd√©pouillement'], ['tout', 'n√©ant'], ['poss√©der', 'renoncer'],
                ['avoir', '√™tre'], ['accumulation', 'd√©pouillement'], ['saisir', 'l√¢cher'],

                // D√©sir et d√©tachement
                ['d√©sir', 'd√©tachement'], ['vouloir', 'renoncer'], ['convoiter', 'abandonner'],
                ['attacher', 'd√©tacher'], ['tenir', 'l√¢cher'], ['garder', 'donner'],

                // Parler et taire (mystique apophatique)
                ['affirmer', 'nier'], ['dire', 'indicible'], ['nommer', 'innommable'],
                ['exprimer', 'inexprimable'], ['comprendre', 'incompr√©hensible'],

                // Repos et effort
                ['repos', 'effort'], ['reposer', 'travailler'], ['sommeil', 'veille'],
                ['contempler', 'agir'], ['qui√©tude', 'asc√®se'], ['passivit√©', 'action'],

                // Nourrir et je√ªner
                ['nourrir', 'je√ªner'], ['manger', 'je√ªner'], ['festin', 'je√ªne'],
                ['sati√©t√©', 'faim'], ['rassasier', 'affamer'], ['abondance', 'abstinence'],

                // Ouverture et fermeture
                ['ouvrir', 'fermer'], ['ouvert', 'ferm√©'], ['accueillir', 'refuser'],
                ['recevoir', 'rejeter'], ['porte ouverte', 'porte ferm√©e'],

                // Sommeil et √©veil (spirituel)
                ['√©veil', 'sommeil'], ['√©veill√©', 'endormi'], ['veille', 'sommeil'],
                ['vigilance', 'torpeur'], ['lucide', 'aveugle'],

                // Monter et descendre (k√©nose/ascension)
                ['monter', 'descendre'], ['ascension', 'descente'], ['√©lever', 'abaisser'],
                ['grimper', 'tomber'], ['lever', 'baisser'],

                // Rassembler et disperser
                ['rassembler', 'disperser'], ['unir', 's√©parer'], ['joindre', 'diviser'],
                ['r√©unir', '√©parpiller'], ['concentrer', 'dissiper'],

                // Remplir et vider (k√©nose)
                ['remplir', 'vider'], ['combler', 'creuser'], ['garnir', 'd√©pouiller'],
                ['emplir', 'vider'], ['saturer', '√©puiser'],

                // Construire et d√©truire
                ['construire', 'd√©truire'], ['√©difier', 'd√©molir'], ['b√¢tir', 'ruiner'],
                ['cr√©er', 'an√©antir'], ['fonder', 'renverser'],

                // Lier et d√©lier (pouvoir des cl√©s)
                ['lier', 'd√©lier'], ['attacher', 'd√©tacher'], ['encha√Æner', 'lib√©rer'],
                ['nouer', 'd√©nouer'], ['retenir', 'rel√¢cher'],

                // Montrer et cacher (myst√®re)
                ['r√©v√©ler', 'cacher'], ['d√©voiler', 'voiler'], ['montrer', 'dissimuler'],
                ['manifester', 'myst√®re'], ['apparent', 'secret'], ['public', 'secret'],

                // Nouveau et ancien
                ['nouveau', 'ancien'], ['neuf', 'vieux'], ['recommencer', 'finir'],
                ['renaissance', 'vieillesse'], ['innovation', 'tradition']
            ];

            motsParadoxaux.forEach(paire => {
                if (phraseLower.includes(paire[0]) && phraseLower.includes(paire[1])) {
                    score += 10;
                }
            });

            if (keyword && phraseLower.includes(keyword.toLowerCase())) {
                score += 15;
            }

            const indicateursParadoxe = ['mais', 'pourtant', 'cependant', 'toutefois',
                'n√©anmoins', 'malgr√©', 'bien que', 'quoique'];
            indicateursParadoxe.forEach(mot => {
                if (phraseLower.includes(mot)) score += 5;
            });

            if (phrase.length > 100 && phrase.length < 300) score += 2;

            return score;
        }

        function getAntonyms(keyword) {
            const antonymesMap = {
                // Lumi√®re et obscurit√©
                'lumi√®re': ['t√©n√®bres', 'obscurit√©', 'ombre', 'nuit', 'noirceur', 'opacit√©'],
                't√©n√®bres': ['lumi√®re', 'clart√©', 'jour', 'luminosit√©', '√©clat'],
                'obscurit√©': ['lumi√®re', 'clart√©', 'luminosit√©', 'transparence'],
                'jour': ['nuit', 't√©n√®bres', 'obscurit√©'],
                'nuit': ['jour', 'lumi√®re', 'aube', 'aurore'],
                'clart√©': ['obscurit√©', 't√©n√®bres', 'opacit√©'],
                'illumination': ['aveuglement', 'obscurit√©', 'ignorance'],
                'aveugle': ['voyant', 'clairvoyant', 'lucide'],
                'voir': ['aveugler', 'ignorer', 'm√©conna√Ætre'],

                // Vie et mort
                'vie': ['mort', 'tr√©pas', 'd√©c√®s', 'agonie', 'fin'],
                'mort': ['vie', 'naissance', 'renaissance', 'r√©surrection'],
                'vivre': ['mourir', 'p√©rir', 'expirer', 'tr√©passer'],
                'mourir': ['vivre', 'na√Ætre', 'rena√Ætre', 'ressusciter'],
                'vivant': ['mort', 'd√©funt', 'inanim√©', 'cadavre'],
                'na√Ætre': ['mourir', 'dispara√Ætre', 'finir'],
                'naissance': ['mort', 'fin', 'terme', 'd√©c√®s'],
                'r√©surrection': ['mort', 'ensevelissement', 'tombeau'],
                'mortel': ['immortel', '√©ternel', 'imp√©rissable'],
                'immortel': ['mortel', 'p√©rissable', '√©ph√©m√®re'],
                'p√©rissable': ['imp√©rissable', '√©ternel', 'immortel'],

                // √ätre et n√©ant
                '√™tre': ['n√©ant', 'non-√™tre', 'rien', 'vide'],
                'n√©ant': ['√™tre', 'existence', 'tout', 'pl√©nitude'],
                'existence': ['n√©ant', 'non-existence', 'absence'],
                'exister': ['n√©ant', 'an√©antir', 'dispara√Ætre'],
                'tout': ['rien', 'n√©ant', 'vide', 'absence'],
                'rien': ['tout', 'pl√©nitude', '√™tre', 'existence'],
                'pl√©nitude': ['vide', 'vacuit√©', 'n√©ant', 'manque'],
                'plein': ['vide', 'creux', 'vacant', 'd√©pouill√©'],
                'vide': ['plein', 'rempli', 'combl√©', 'satur√©'],
                'pr√©sence': ['absence', '√©loignement', 'manque'],
                'absence': ['pr√©sence', 'proximit√©', 'pr√©sent'],
                'an√©antir': ['cr√©er', '√™tre', 'exister', 'subsister'],

                // Connaissance et ignorance
                'savoir': ['ignorer', 'm√©conna√Ætre', 'ignorer'],
                'ignorer': ['savoir', 'conna√Ætre', 'comprendre'],
                'connaissance': ['ignorance', 'm√©connaissance', 'aveuglement'],
                'ignorance': ['connaissance', 'savoir', 'science', 'sagesse'],
                'sagesse': ['folie', 'sottise', 'd√©raison', 'ignorance'],
                'folie': ['sagesse', 'raison', 'sens', 'prudence'],
                'sage': ['fou', 'insens√©', 'ignorant'],
                'fou': ['sage', 'sens√©', 'raisonnable'],
                'connu': ['inconnu', 'ignor√©', 'cach√©', 'myst√©rieux'],
                'inconnu': ['connu', 'familier', 'r√©v√©l√©', 'manifeste'],
                'comprendre': ['ignorer', 'm√©conna√Ætre', 'incompr√©hensible'],
                'incompr√©hensible': ['compr√©hensible', 'clair', '√©vident', 'intelligible'],
                'certain': ['incertain', 'douteux', 'h√©sitant'],
                'incertain': ['certain', 's√ªr', 'assur√©', '√©vident'],
                'science': ['ignorance', 'm√©connaissance', 'aveuglement'],
                'r√©v√©ler': ['cacher', 'voiler', 'dissimuler', 'occulter'],
                'cacher': ['r√©v√©ler', 'montrer', 'd√©voiler', 'manifester'],
                'manifeste': ['cach√©', 'secret', 'occulte', 'myst√©rieux'],
                'cach√©': ['manifeste', 'visible', 'apparent', 'r√©v√©l√©'],
                'visible': ['invisible', 'cach√©', 'occulte', 'secret'],
                'invisible': ['visible', 'apparent', 'manifeste', '√©vident'],
                'appara√Ætre': ['dispara√Ætre', 'cacher', 'voiler'],
                'dispara√Ætre': ['appara√Ætre', 'surgir', 'se montrer'],
                'montrer': ['cacher', 'voiler', 'dissimuler'],
                'voiler': ['d√©voiler', 'r√©v√©ler', 'montrer', 'd√©couvrir'],
                'd√©voiler': ['voiler', 'cacher', 'dissimuler', 'recouvrir'],
                'secret': ['public', 'manifeste', 'ouvert', 'r√©v√©l√©'],
                'myst√®re': ['r√©v√©lation', '√©vidence', 'clart√©'],

                // Foi et doute
                'foi': ['doute', 'incr√©dulit√©', 'incroyance', 'scepticisme'],
                'doute': ['foi', 'certitude', 'croyance', 'conviction'],
                'croire': ['douter', 'm√©croire', 'renier'],
                'douter': ['croire', 'avoir foi', '√™tre certain'],
                'certitude': ['doute', 'incertitude', 'h√©sitation'],
                'confiance': ['m√©fiance', 'd√©fiance', 'suspicion', 'doute'],
                'm√©fiance': ['confiance', 'foi', 'assurance'],
                'espoir': ['d√©sespoir', 'd√©sesp√©rance', 'd√©couragement'],
                'd√©sespoir': ['espoir', 'esp√©rance', 'confiance'],
                'esp√©rance': ['d√©sesp√©rance', 'd√©sespoir', 'd√©couragement'],
                'croyant': ['incroyant', 'infid√®le', 'm√©cr√©ant', 'ath√©e'],
                'fid√®le': ['infid√®le', 'ren√©gat', 'apostat', 'tra√Ætre'],

                // Amour et haine
                'amour': ['haine', 'aversion', 'r√©pulsion', 'hostilit√©', 'indiff√©rence'],
                'haine': ['amour', 'charit√©', 'affection', 'tendresse'],
                'aimer': ['ha√Ør', 'd√©tester', 'abhorrer', 'm√©priser'],
                'ha√Ør': ['aimer', 'ch√©rir', 'adorer'],
                'charit√©': ['√©go√Øsme', 'avarice', 'cupidit√©', 'haine'],
                '√©go√Øsme': ['charit√©', 'altruisme', 'g√©n√©rosit√©', 'don'],
                'dilection': ['aversion', 'r√©pulsion', 'haine'],
                'aversion': ['dilection', 'attraction', 'amour'],
                'attraction': ['r√©pulsion', 'aversion', 'rejet'],
                'r√©pulsion': ['attraction', 'attrait', 'amour'],

                // Bien et mal
                'bien': ['mal', 'vice', 'p√©ch√©', 'faute', 'crime'],
                'mal': ['bien', 'vertu', 'bont√©', 'justice'],
                'bon': ['mauvais', 'm√©chant', 'pervers', 'vicieux'],
                'mauvais': ['bon', 'bienfaisant', 'vertueux'],
                'vertu': ['vice', 'p√©ch√©', 'd√©faut', 'mal'],
                'vice': ['vertu', 'qualit√©', 'bien', 'm√©rite'],
                'juste': ['injuste', 'inique', 'in√©quitable'],
                'injuste': ['juste', '√©quitable', 'droit'],
                'justice': ['injustice', 'iniquit√©', 'in√©quit√©'],
                'injustice': ['justice', '√©quit√©', 'droiture'],
                'saintet√©': ['p√©ch√©', 'vice', 'corruption', 'impi√©t√©'],
                'saint': ['p√©cheur', 'impie', 'profane', 'damn√©'],
                'p√©ch√©': ['saintet√©', 'gr√¢ce', 'vertu', 'puret√©'],
                'p√©cheur': ['saint', 'juste', '√©lu', 'bienheureux'],
                'pur': ['impur', 'souill√©', 'corrompu', 'contamin√©'],
                'impur': ['pur', 'innocent', 'immacul√©', 'saint'],
                'puret√©': ['impuret√©', 'souillure', 'corruption'],
                'impuret√©': ['puret√©', 'innocence', 'saintet√©'],
                'innocent': ['coupable', 'criminel', 'fautif'],
                'coupable': ['innocent', 'irr√©prochable', 'pur'],

                // Paix et guerre
                'paix': ['guerre', 'conflit', 'combat', 'lutte', 'hostilit√©'],
                'guerre': ['paix', 'harmonie', 'concorde', 'repos'],
                'repos': ['combat', 'lutte', 'effort', 'agitation'],
                'combat': ['repos', 'paix', 'tr√™ve', 'calme'],
                'calme': ['temp√™te', 'agitation', 'trouble', 'tumulte'],
                'temp√™te': ['calme', 's√©r√©nit√©', 'tranquillit√©', 'bonace'],
                'tranquillit√©': ['trouble', 'agitation', 'tumulte', 'tourment'],
                'trouble': ['tranquillit√©', 'calme', 'paix', 's√©r√©nit√©'],
                'qui√©tude': ['agitation', 'trouble', 'inqui√©tude', 'tourment'],
                'agitation': ['qui√©tude', 'calme', 'repos', 'paix'],
                's√©r√©nit√©': ['tourment', 'angoisse', 'trouble', 'agitation'],
                'tourment': ['s√©r√©nit√©', 'paix', 'repos', 'qui√©tude'],

                // Grandeur et petitesse
                'grand': ['petit', 'infime', 'minuscule', 'humble'],
                'petit': ['grand', 'immense', '√©norme', '√©lev√©'],
                'grandeur': ['petitesse', 'humilit√©', 'bassesse', 'mesquinerie'],
                'petitesse': ['grandeur', 'majest√©', 'magnificence', '√©l√©vation'],
                'immense': ['infime', 'minuscule', 'microscopique'],
                'infime': ['immense', '√©norme', 'gigantesque', 'colossal'],
                '√©lev√©': ['bas', 'inf√©rieur', 'vil', 'abject'],
                'bas': ['√©lev√©', 'haut', 'sublime', 'sup√©rieur'],
                'haut': ['bas', 'inf√©rieur', 'profond', 'abject'],
                'sublime': ['vil', 'bas', 'abject', 'humble'],
                'vil': ['sublime', 'noble', '√©lev√©', 'digne'],
                'majest√©': ['humilit√©', 'bassesse', 'petitesse'],
                'gloire': ['abaissement', 'humiliation', 'opprobre', 'honte'],
                'abaissement': ['gloire', '√©l√©vation', 'exaltation', 'grandeur'],
                '√©l√©vation': ['abaissement', 'chute', 'd√©ch√©ance'],
                'exaltation': ['humiliation', 'abaissement', 'avilissement'],
                'humiliation': ['exaltation', 'gloire', 'honneur', 'dignit√©'],

                // Richesse et pauvret√©
                'riche': ['pauvre', 'indigent', 'd√©muni', 'd√©pouill√©'],
                'pauvre': ['riche', 'opulent', 'fortun√©', 'nanti'],
                'richesse': ['pauvret√©', 'indigence', 'd√©nuement', 'mis√®re'],
                'pauvret√©': ['richesse', 'opulence', 'fortune', 'abondance'],
                'poss√©der': ['d√©pouiller', 'manquer', 'perdre', 'renoncer'],
                'd√©pouiller': ['poss√©der', 'avoir', 'garder', 'accumuler'],
                'avoir': ['manquer', 'perdre', '√™tre priv√©', 'renoncer'],
                'manquer': ['avoir', 'poss√©der', 'abonder', 'regorger'],
                'abondance': ['d√©nuement', 'p√©nurie', 'manque', 'privation'],
                'd√©nuement': ['abondance', 'richesse', 'opulence', 'pl√©nitude'],
                'donner': ['recevoir', 'prendre', 'garder', 'retenir'],
                'recevoir': ['donner', 'offrir', 'prodiguer'],
                'perdre': ['gagner', 'trouver', 'acqu√©rir', 'obtenir'],
                'gagner': ['perdre', 'perdre', 'sacrifier', 'renoncer'],
                'abandonner': ['garder', 'retenir', 'conserver', 'poss√©der'],
                'garder': ['abandonner', 'perdre', 'donner', 'l√¢cher'],

                // Force et faiblesse
                'fort': ['faible', 'd√©bile', 'impuissant', 'fragile'],
                'faible': ['fort', 'puissant', 'robuste', 'vigoureux'],
                'force': ['faiblesse', 'd√©bilit√©', 'impuissance', 'fragilit√©'],
                'faiblesse': ['force', 'puissance', 'vigueur', 'robustesse'],
                'puissance': ['impuissance', 'faiblesse', 'incapacit√©'],
                'impuissance': ['puissance', 'force', 'capacit√©', 'pouvoir'],
                'pouvoir': ['impuissance', 'incapacit√©', 'faiblesse'],
                'capable': ['incapable', 'impuissant', 'inapte'],
                'incapable': ['capable', 'apte', 'comp√©tent'],
                'victorieux': ['vaincu', 'd√©fait', '√©cras√©'],
                'vaincu': ['victorieux', 'vainqueur', 'triomphant'],
                'victoire': ['d√©faite', '√©chec', 'revers'],
                'd√©faite': ['victoire', 'triomphe', 'succ√®s'],

                // Libert√© et servitude
                'libre': ['esclave', 'captif', 'prisonnier', 'encha√Æn√©'],
                'esclave': ['libre', 'affranchi', 'lib√©r√©', 'ma√Ætre'],
                'libert√©': ['servitude', 'esclavage', 'captivit√©', 'asservissement'],
                'servitude': ['libert√©', 'affranchissement', 'ind√©pendance'],
                'lib√©rer': ['encha√Æner', 'asservir', 'capturer', 'emprisonner'],
                'encha√Æner': ['lib√©rer', 'affranchir', 'd√©livrer', 'd√©lier'],
                'd√©livrer': ['captif', 'encha√Æner', 'emprisonner'],
                'captif': ['libre', 'd√©livr√©', 'lib√©r√©', 'affranchi'],
                'autonomie': ['d√©pendance', 'subordination', 'asservissement'],
                'd√©pendance': ['autonomie', 'ind√©pendance', 'libert√©'],
                'ind√©pendant': ['d√©pendant', 'subordonn√©', 'assujetti'],
                'd√©pendant': ['ind√©pendant', 'autonome', 'libre'],

                // Premier et dernier
                'premier': ['dernier', 'ultime', 'final', 'terminal'],
                'dernier': ['premier', 'initial', 'originel', 'primordial'],
                'commencer': ['finir', 'terminer', 'achever', 'conclure'],
                'finir': ['commencer', 'd√©buter', 'initier', 'inaugurer'],
                'd√©but': ['fin', 'terme', 'conclusion', 'ach√®vement'],
                'fin': ['d√©but', 'commencement', 'origine', 'principe'],
                'origine': ['terme', 'fin', 'aboutissement', 'conclusion'],
                'terme': ['origine', 'principe', 'source', 'commencement'],
                'alpha': ['om√©ga', 'fin', 'terme'],
                'om√©ga': ['alpha', 'origine', 'principe'],
                'principe': ['fin', 'terme', 'aboutissement', 'conclusion'],

                // Ma√Ætre et serviteur
                'ma√Ætre': ['serviteur', 'esclave', 'sujet', 'vassal'],
                'serviteur': ['ma√Ætre', 'seigneur', 'patron', 'chef'],
                'seigneur': ['serviteur', 'vassal', 'sujet', 'serf'],
                'commander': ['ob√©ir', 'servir', 'se soumettre'],
                'ob√©ir': ['commander', 'ordonner', 'diriger', 'r√©gner'],
                'dominer': ['servir', 'ob√©ir', 'se soumettre', '√™tre soumis'],
                'servir': ['dominer', 'commander', 'r√©gner', 'gouverner'],
                'roi': ['esclave', 'sujet', 'serviteur', 'vassal'],
                'souverain': ['sujet', 'vassal', 'serviteur'],

                // Int√©rieur et ext√©rieur
                'dedans': ['dehors', 'ext√©rieur', 'hors', '√† l\'ext√©rieur'],
                'dehors': ['dedans', 'int√©rieur', 'au-dedans'],
                'int√©rieur': ['ext√©rieur', 'dehors', 'externe', 'superficiel'],
                'ext√©rieur': ['int√©rieur', 'intime', 'profond', 'dedans'],
                'intime': ['lointain', 'distant', 'ext√©rieur', '√©tranger'],
                'lointain': ['proche', 'intime', 'voisin', 'adjacent'],
                'proche': ['lointain', '√©loign√©', 'distant', 'recul√©'],
                '√©loign√©': ['proche', 'voisin', 'adjacent', 'contigu'],
                'proximit√©': ['distance', '√©loignement', '√©cart'],
                'distance': ['proximit√©', 'voisinage', 'contigu√Øt√©'],

                // Unit√© et multiplicit√©
                'un': ['multiple', 'divers', 'nombreux', 'pluriel'],
                'multiple': ['un', 'unique', 'seul', 'singulier'],
                'unit√©': ['multiplicit√©', 'diversit√©', 'pluralit√©'],
                'multiplicit√©': ['unit√©', 'unicit√©', 'singularit√©'],
                'unique': ['multiple', 'divers', 'pluriel', 'nombreux'],
                'divers': ['unique', 'un', 'uniforme', 'identique'],
                'simple': ['compos√©', 'complexe', 'multiple', 'composite'],
                'compos√©': ['simple', '√©l√©mentaire', 'pur', 'unique'],
                'simplicit√©': ['complexit√©', 'complication', 'multiplicit√©'],
                'complexit√©': ['simplicit√©', 'simplicit√©', 'puret√©'],
                'indivisible': ['divisible', 's√©cable', 's√©parable'],
                'divisible': ['indivisible', 'ins√©cable', 'ins√©parable'],

                // Parole et silence
                'parole': ['silence', 'mutisme', 'taciturnit√©'],
                'silence': ['parole', 'verbe', 'discours', 'bruit'],
                'parler': ['taire', 'se taire', 'garder silence'],
                'taire': ['parler', 'dire', 'prononcer', 'exprimer'],
                'dire': ['taire', 'celer', 'cacher', 'dissimuler'],
                'verbe': ['silence', 'mutisme', 'taciturnit√©'],
                'exprimer': ['taire', 'cacher', 'dissimuler', 'occulter'],
                'proclamer': ['cacher', 'taire', 'dissimuler', 'voiler'],
                'muet': ['√©loquent', 'bavard', 'loquace', 'disert'],
                '√©loquent': ['muet', 'silencieux', 'taciturne'],

                // Activit√© et passivit√©
                'agir': ['subir', 'p√¢tir', 'souffrir', 'endurer'],
                'subir': ['agir', 'faire', 'accomplir', '≈ìuvrer'],
                'actif': ['passif', 'inactif', 'inerte', 'oisif'],
                'passif': ['actif', 'agissant', 'actif', 'dynamique'],
                'action': ['passion', 'inaction', 'repos', 'passivit√©'],
                'passion': ['action', 'activit√©', 'agir'],
                'faire': ['laisser', 'subir', 's\'abstenir', 'ne rien faire'],
                'laisser': ['faire', 'agir', 'intervenir', '≈ìuvrer'],
                'effort': ['abandon', 'rel√¢chement', 'repos', 'passivit√©'],
                'abandon': ['effort', 'r√©sistance', 'lutte', 'combat'],
                'volont√©': ['abandon', 'r√©signation', 'soumission'],
                'travailler': ['reposer', 'se reposer', 'ch√¥mer', 'cesser'],
                '≈ìuvre': ['gr√¢ce', 'don', 'cadeau', 'faveur'],
                'gr√¢ce': ['≈ìuvre', 'm√©rite', 'effort', 'travail'],
                'm√©rite': ['gr√¢ce', 'don', 'faveur', 'cadeau'],
                'don': ['m√©rite', '≈ìuvre', 'effort', 'r√©compense'],

                // Mouvement et repos
                'mouvement': ['repos', 'immobilit√©', 'stase', 'arr√™t'],
                'repos': ['mouvement', 'agitation', 'activit√©', 'motion'],
                'mobile': ['immobile', 'fixe', 'stationnaire', 'stable'],
                'immobile': ['mobile', 'mouvant', 'agile', 'instable'],
                'marcher': ['demeurer', 'rester', 's\'arr√™ter', 'stationner'],
                'demeurer': ['partir', 'quitter', 'marcher', 'voyager'],
                'aller': ['rester', 'demeurer', 'stationner', 's\'arr√™ter'],
                'rester': ['partir', 'aller', 'quitter', 'se mouvoir'],
                'avancer': ['reculer', 'arr√™ter', 'stopper', 'immobiliser'],
                'arr√™ter': ['avancer', 'progresser', 'continuer', 'poursuivre'],
                'chercher': ['trouver', 'poss√©der', 'avoir'],
                'trouver': ['chercher', 'perdre', '√©garer'],
                'errer': ['habiter', 'demeurer', 'r√©sider', 's√©journer'],
                'habiter': ['errer', 'vagabonder', 'voyager', 'nomadiser'],
                'exil': ['demeure', 'patrie', 'foyer', 'r√©sidence'],
                'demeure': ['exil', 'd√©part', 'errance', 'nomadisme'],
                'voyage': ['s√©jour', 'r√©sidence', 'demeure', 'installation'],
                's√©jour': ['voyage', 'd√©part', 'exode', 'migration'],

                // Temps et √©ternit√©
                'temps': ['√©ternit√©', 'intemporel', 'sempiternel'],
                '√©ternit√©': ['temps', 'temporalit√©', 'dur√©e', 'instant'],
                'temporel': ['√©ternel', 'intemporel', 'sempiternel', 'permanent'],
                '√©ternel': ['temporel', 'passager', '√©ph√©m√®re', 'transitoire'],
                '√©ph√©m√®re': ['√©ternel', 'permanent', 'durable', 'imp√©rissable'],
                'permanent': ['√©ph√©m√®re', 'passager', 'transitoire', 'fugace'],
                'passager': ['permanent', 'durable', '√©ternel', 'stable'],
                'transitoire': ['permanent', 'stable', 'durable', 'immuable'],
                'changeant': ['immuable', 'invariable', 'constant', 'stable'],
                'immuable': ['changeant', 'variable', 'instable', 'fluctuant'],
                'corruptible': ['incorruptible', 'imp√©rissable', '√©ternel'],
                'incorruptible': ['corruptible', 'p√©rissable', 'alt√©rable'],

                // Terre et ciel
                'terre': ['ciel', 'paradis', 'empyr√©e', 'firmament'],
                'ciel': ['terre', 'monde', 'bas monde', 'ici-bas'],
                'terrestre': ['c√©leste', '√©th√©r√©', 'divin', 'paradisiaque'],
                'c√©leste': ['terrestre', 'mondain', 's√©culier', 'temporel'],
                'mat√©riel': ['spirituel', 'immat√©riel', 'incorporel'],
                'spirituel': ['mat√©riel', 'corporel', 'charnel', 'physique'],
                'corporel': ['spirituel', 'incorporel', 'immat√©riel'],
                'chair': ['esprit', '√¢me', 'spirituel'],
                'esprit': ['chair', 'corps', 'mati√®re', 'corporel'],
                'charnel': ['spirituel', 'incorporel', 'immat√©riel'],
                'monde': ['ciel', 'paradis', 'royaume', '√©ternit√©'],
                's√©culier': ['sacr√©', 'religieux', 'spirituel', 'divin'],

                // Sacr√© et profane
                'sacr√©': ['profane', 's√©culier', 'la√Øc', 'temporel'],
                'profane': ['sacr√©', 'saint', 'consacr√©', 'b√©ni'],
                'saint': ['profane', 'p√©cheur', 'impie', 'sacril√®ge'],
                'divin': ['humain', 'mortel', 'terrestre', 'mondain'],
                'humain': ['divin', 'c√©leste', 'transcendant', 'surnaturel'],
                'surnaturel': ['naturel', 'ordinaire', 'commun', 'profane'],
                'naturel': ['surnaturel', 'miraculeux', 'prodigieux', 'divin'],
                'transcendant': ['immanent', 'terrestre', 'mondain'],
                'immanent': ['transcendant', 'au-del√†', 'sup√©rieur'],

                // Soi et autre
                'soi': ['autre', 'autrui', '√©tranger', 'prochain'],
                'autre': ['soi', 'm√™me', 'propre', 'identique'],
                'je': ['tu', 'il', 'autre', 'autrui'],
                'tu': ['je', 'moi', 'soi'],
                'moi': ['toi', 'lui', 'autre', 'autrui'],
                'toi': ['moi', 'je', 'soi'],
                'propre': ['√©tranger', 'autre', 'autrui', 'externe'],
                '√©tranger': ['familier', 'propre', 'intime', 'proche'],
                'm√™me': ['autre', 'diff√©rent', 'distinct', 'divers'],
                'identit√©': ['alt√©rit√©', 'diff√©rence', 'distinction'],
                'alt√©rit√©': ['identit√©', 'm√™met√©', 'similitude'],

                // V√©rit√© et erreur
                'vrai': ['faux', 'erron√©', 'inexact', 'mensonger'],
                'faux': ['vrai', 'v√©ridique', 'exact', 'authentique'],
                'v√©rit√©': ['erreur', 'mensonge', 'fausset√©', 'illusion'],
                'erreur': ['v√©rit√©', 'exactitude', 'justesse', 'v√©racit√©'],
                'mensonge': ['v√©rit√©', 'v√©racit√©', 'sinc√©rit√©', 'franchise'],
                'authentique': ['faux', 'illusoire', 'trompeur', 'factice'],
                'illusoire': ['r√©el', 'authentique', 'v√©ritable', 'effectif'],
                'r√©el': ['apparent', 'illusoire', 'fictif', 'chim√©rique'],
                'apparent': ['r√©el', 'v√©ritable', 'authentique', 'effectif'],
                '√™tre': ['para√Ætre', 'sembler', 'appara√Ætre'],
                'para√Ætre': ['√™tre', 'exister r√©ellement'],

                // Joie et tristesse
                'joie': ['tristesse', 'douleur', 'peine', 'affliction', 'chagrin'],
                'tristesse': ['joie', 'all√©gresse', 'gaiet√©', 'f√©licit√©'],
                'douleur': ['joie', 'plaisir', 'd√©lice', 'f√©licit√©'],
                'consolation': ['d√©solation', 'affliction', 'd√©tresse'],
                'd√©solation': ['consolation', 'r√©confort', 'soulagement'],
                'all√©gresse': ['affliction', 'tristesse', 'd√©solation', 'peine'],
                'affliction': ['all√©gresse', 'joie', 'consolation', 'f√©licit√©'],
                'bonheur': ['malheur', 'infortune', 'mis√®re', 'd√©tresse'],
                'malheur': ['bonheur', 'f√©licit√©', 'b√©atitude', 'prosp√©rit√©'],
                'b√©atitude': ['souffrance', 'mis√®re', 'tourment', 'affliction'],
                'souffrance': ['b√©atitude', 'joie', 'd√©lice', 'volupt√©'],

                // Souffrance et gloire
                'souffrance': ['gloire', 'b√©atitude', 'joie', 'honneur'],
                'gloire': ['souffrance', 'humiliation', 'opprobre', 'ignominie'],
                'croix': ['gloire', 'triomphe', 'r√©surrection', 'couronne'],
                'passion': ['r√©surrection', 'gloire', 'triomphe', 'victoire'],
                'r√©surrection': ['passion', 'mort', 'crucifixion', 'tombeau'],

                // D√©sir et d√©tachement
                'd√©sir': ['d√©tachement', 'renoncement', 'abandon', 'indiff√©rence'],
                'd√©tachement': ['d√©sir', 'attachement', 'convoitise', 'avidit√©'],
                'vouloir': ['renoncer', 'abandonner', 'l√¢cher', 'd√©laisser'],
                'renoncer': ['d√©sirer', 'vouloir', 'convoiter', 'ambitionner'],
                'convoiter': ['renoncer', 'abandonner', 'd√©laisser', 'm√©priser'],
                'attacher': ['d√©tacher', 'd√©lier', 'lib√©rer', 'affranchir'],
                'd√©tacher': ['attacher', 'lier', 'encha√Æner', 'fixer'],
                'tenir': ['l√¢cher', 'abandonner', 'rel√¢cher', 'lib√©rer'],
                'l√¢cher': ['tenir', 'saisir', 'agripper', 'retenir'],

                // Parler et taire (apophatisme)
                'affirmer': ['nier', 'd√©mentir', 'r√©futer', 'contester'],
                'nier': ['affirmer', 'confirmer', 'attester', 'certifier'],
                'indicible': ['exprimable', 'dicible', '√©non√ßable'],
                'innommable': ['nommable', 'd√©signable', 'd√©finissable'],
                'inexprimable': ['exprimable', 'dicible', '√©non√ßable'],
                'nommer': ['innommable', 'indicible', 'ineffable'],

                // Humilit√© et orgueil
                'humble': ['orgueilleux', 'hautain', 'fier', 'arrogant', 'superbe'],
                'orgueilleux': ['humble', 'modeste', 'effac√©', 'simple'],
                'humilit√©': ['orgueil', 'vanit√©', 'fiert√©', 'arrogance', 'superbe'],
                'orgueil': ['humilit√©', 'modestie', 'simplicit√©', 'effacement'],
                'modestie': ['vanit√©', 'orgueil', 'suffisance', 'pr√©tention'],
                'vanit√©': ['humilit√©', 'modestie', 'simplicit√©'],

                // Ouverture et fermeture
                'ouvrir': ['fermer', 'clore', 'boucher', 'obstruer'],
                'fermer': ['ouvrir', 'ouvrir', 'd√©boucher', 'd√©gager'],
                'ouvert': ['ferm√©', 'clos', 'bouch√©', 'obstru√©'],
                'ferm√©': ['ouvert', 'b√©ant', 'accessible', 'disponible'],
                'accueillir': ['refuser', 'rejeter', 'repousser', '√©carter'],
                'refuser': ['accueillir', 'accepter', 'recevoir', 'agr√©er'],
                'rejeter': ['recevoir', 'accepter', 'accueillir', 'adopter'],

                // Sommeil et √©veil
                '√©veil': ['sommeil', 'assoupissement', 'torpeur', 'l√©thargie'],
                'sommeil': ['√©veil', 'veille', 'vigilance', 'insomnie'],
                '√©veill√©': ['endormi', 'assoupi', 'somnolent'],
                'endormi': ['√©veill√©', 'vigilant', 'alerte', 'lucide'],
                'veille': ['sommeil', 'assoupissement', 'l√©thargie'],
                'vigilance': ['torpeur', 'somnolence', 'assoupissement'],
                'torpeur': ['vigilance', '√©veil', 'lucidit√©', 'vivacit√©'],
                'lucide': ['aveugle', 'endormi', 'inconscient', 'confus'],

                // Monter et descendre
                'monter': ['descendre', 'tomber', 'choir', 'd√©choir'],
                'descendre': ['monter', 'gravir', 'escalader', 's\'√©lever'],
                'ascension': ['descente', 'chute', 'd√©ch√©ance', 'abaissement'],
                'descente': ['ascension', 'mont√©e', '√©l√©vation', 'ascension'],
                '√©lever': ['abaisser', 'rabaisser', 'humilier', 'avilir'],
                'abaisser': ['√©lever', 'hausser', 'exhausser', 'exalter'],
                'grimper': ['tomber', 'chuter', 'd√©gringoler', 'choir'],
                'tomber': ['monter', 'grimper', 's\'√©lever', 'se dresser'],
                'lever': ['baisser', 'abaisser', 'descendre', 'rabattre'],
                'baisser': ['lever', '√©lever', 'hausser', 'dresser'],
                'chute': ['ascension', '√©l√©vation', 'mont√©e', 'essor'],

                // Rassembler et disperser
                'rassembler': ['disperser', '√©parpiller', 'diss√©miner', 'r√©pandre'],
                'disperser': ['rassembler', 'r√©unir', 'grouper', 'concentrer'],
                'unir': ['s√©parer', 'diviser', 'd√©sunir', 'dissocier'],
                's√©parer': ['unir', 'joindre', 'r√©unir', 'rassembler'],
                'joindre': ['s√©parer', 'disjoindre', 'diviser', '√©carter'],
                'diviser': ['unir', 'r√©unir', 'joindre', 'rassembler'],
                'r√©unir': ['s√©parer', '√©parpiller', 'disperser', 'dissocier'],
                '√©parpiller': ['rassembler', 'r√©unir', 'concentrer', 'grouper'],
                'concentrer': ['disperser', '√©parpiller', 'diss√©miner'],
                'dissiper': ['concentrer', 'rassembler', 'condenser'],

                // Remplir et vider
                'remplir': ['vider', '√©vacuer', '√©puiser', 'tarir'],
                'vider': ['remplir', 'emplir', 'combler', 'garnir'],
                'combler': ['creuser', 'vider', '√©puiser', 'tarir'],
                'creuser': ['combler', 'remplir', 'boucher', 'emplir'],
                'garnir': ['d√©pouiller', 'd√©garnir', 'vider', 'd√©nuder'],
                'd√©pouiller': ['garnir', 'rev√™tir', 'habiller', 'parer'],
                'emplir': ['vider', '√©vacuer', '√©puiser', 'tarir'],
                'saturer': ['√©puiser', 'vider', 'tarir', 'ass√©cher'],
                '√©puiser': ['remplir', 'combler', 'alimenter', 'fournir'],

                // Construire et d√©truire
                'construire': ['d√©truire', 'd√©molir', 'abattre', 'raser'],
                'd√©truire': ['construire', '√©difier', 'b√¢tir', '√©riger'],
                '√©difier': ['d√©molir', 'd√©truire', 'abattre', 'renverser'],
                'd√©molir': ['√©difier', 'construire', '√©riger', 'b√¢tir'],
                'b√¢tir': ['ruiner', 'd√©truire', 'd√©molir', 'abattre'],
                'ruiner': ['√©difier', 'construire', 'b√¢tir', 'restaurer'],
                'cr√©er': ['an√©antir', 'd√©truire', 'annihiler', 'abolir'],
                'fonder': ['renverser', 'd√©truire', 'abolir', 'ruiner'],
                'renverser': ['fonder', '√©tablir', '√©riger', '√©difier'],

                // Lier et d√©lier
                'lier': ['d√©lier', 'd√©tacher', 'lib√©rer', 'd√©nouer'],
                'd√©lier': ['lier', 'attacher', 'nouer', 'encha√Æner'],
                'attacher': ['d√©tacher', 'd√©lier', 'lib√©rer', 'd√©gager'],
                'd√©tacher': ['attacher', 'lier', 'fixer', 'amarrer'],
                'nouer': ['d√©nouer', 'd√©lier', 'd√©faire', 'd√©tacher'],
                'd√©nouer': ['nouer', 'lier', 'attacher', 'entrelacer'],
                'retenir': ['rel√¢cher', 'l√¢cher', 'lib√©rer', 'd√©livrer'],
                'rel√¢cher': ['retenir', 'maintenir', 'garder', 'tenir'],

                // Nouveau et ancien
                'nouveau': ['ancien', 'vieux', 'antique', 'archa√Øque'],
                'ancien': ['nouveau', 'neuf', 'r√©cent', 'moderne'],
                'neuf': ['vieux', 'us√©', 'ancien', 'v√©tuste'],
                'vieux': ['neuf', 'nouveau', 'jeune', 'r√©cent'],
                'recommencer': ['finir', 'terminer', 'achever', 'conclure'],
                'renaissance': ['mort', 'fin', 'd√©clin', 'vieillesse'],
                'vieillesse': ['jeunesse', 'renaissance', 'renouveau'],
                'innovation': ['tradition', 'conservation', 'habitude'],
                'tradition': ['innovation', 'renouvellement', 'modernit√©']
            };

            let antonymes = antonymesMap[keyword] || [];

            for (let [key, values] of Object.entries(antonymesMap)) {
                if (values.includes(keyword)) {
                    antonymes.push(key);
                    antonymes = antonymes.concat(antonymesMap[key] || []);
                }
            }

            return [...new Set(antonymes)];
        }

        // Ancienne fonction adapt√©e pour accepter directement le texte pr√©par√©
        async function runAIAnalysis(candidates, keyword = '', numCitations = 5) {

            // Si c'est une cha√Æne brute (ancien format), on l'utilise, sinon on pr√©pare le texte
            const candidateTexts = Array.isArray(candidates)
                ? candidates.map(c => c.phrase).join('\n---\n')
                : candidates;

            const prompt = `Tu es un expert en spiritualit√© chr√©tienne et musulmane, sp√©cialis√© dans l'identification des paradoxes mystiques.

OBLIGATION ABSOLUE : 
Tu ne dois RIEN inventer. Tu dois RECOPIER MOT POUR MOT les phrases du texte fourni, sans changer une seule virgule, sans corriger la grammaire, sans ajouter de guillemets. Toute modification du texte original est une faute grave.

D√âFINITION D'UN PARADOXE SPIRITUEL :
Un paradoxe spirituel pr√©sente une v√©rit√© qui d√©fie la logique ordinaire, o√π deux r√©alit√©s apparemment contradictoires coexistent ou se r√©v√®lent mutuellement. Ce n'est pas une simple juxtaposition d'antonymes, mais une tension dialectique o√π l'un r√©v√®le l'autre.

CRIT√àRE D'INTENSIT√â :
Je ne veux PAS de phrases "plates" ou simplement explicatives. Je veux des fulgurances, des aphorismes, des phrases qui cognent.

EXEMPLES DE VRAIS PARADOXES SPIRITUELS (CE QUE JE VEUX) :
- "Mourir pour vivre"
- "La nuit obscure illumine"
- "Plus on poss√®de Dieu, moins on Le poss√®de"
- "√ätre roi en devenant serviteur"
- "Tout avoir en n'ayant rien"
- "L'√©loignement est proximit√©"
- "L'ivresse par la sobri√©t√©"
- "Rien n'existe que Lui, pourtant tout existe"

CE QUE TU DOIS ABSOLUMENT REJETER (LE "BANAL") :
1. Les explications th√©ologiques ou dogmatiques "techniques" :
   NON : "Le bapt√™me ne fait pas seulement participer le baptis√© √† la mort et √† la r√©surrection du Christ, mais au Christ Lui-m√™me." (C'est une explication de fonctionnement, c'est trop p√©dagogique).
   NON : "Mourir √† la condition d√©chue et rena√Ætre √† la condition de l‚Äôhomme r√©g√©n√©r√©." (Trop descriptif/scolaire).

2. Les simples contrastes temporels ou descriptifs :
   NON : "Apr√®s la nuit vient le jour."
   NON : "Il √©tait triste puis il fut joyeux."

3. Les phrases trop longues, molles ou dilu√©es.

PASSAGES √Ä ANALYSER (RECOPIE EN UN PARMI CEUX-L√Ä) :
${candidateTexts}

T√ÇCHE : S√©lectionne exactement ${numCitations} citations de la liste ci-dessus qui :
1. Sont des APHORISMES percutants.
2. Contiennent un VRAI paradoxe mystique.
3. Sont RECOPI√âES RIGOUREUSEMENT MOT POUR MOT.
${keyword ? `4. Privil√©gie (sans obligation) les citations contenant "${keyword}" si elles sont paradoxales.\n` : ''}

FORMAT DE R√âPONSE :
- Une citation par ligne
- AUCUN TEXTE AVANT OU APR√àS (Pas de "Voici les citations", pas de "D'accord")
- Aucune num√©rotation, aucun commentaire, aucune explication
- Phrases EXACTES du texte

R√©ponds maintenant avec les citations uniquement :`;

            let attempts = 0;
            currentModelIndex = 0;

            while (attempts < MAX_ATTEMPTS_PER_BOOK && currentModelIndex < OPENROUTER_MODELS.length) {
                const model = OPENROUTER_MODELS[currentModelIndex];

                try {
                    showMessage(`ü§ñ IA active - Mod√®le: ${model.split('/')[1].split(':')[0]}...`, 'loading');

                    console.log('Envoi au proxy:', {
                        model: model,
                        message_length: prompt.length
                    });

                    const response = await callOpenRouterAPI(prompt, model);

                    if (response && response.trim().length > 0) {
                        // Nettoyage des phrases d'introduction type "Voici les citations..."
                        const garbage = ["voici", "d'accord", "bien s√ªr", "s√©lection", "extrait", "citation"];
                        const filteredCitations = response
                            .split('\n')
                            .map(line => line.trim().replace(/^["']|["']$/g, '')) // Enl√®ve aussi les guillemets superflus
                            .filter(line => {
                                if (line.length < 15) return false;
                                const lower = line.toLowerCase();
                                return !garbage.some(g => lower.startsWith(g) && lower.endsWith(':'));
                            })
                            .slice(0, numCitations);

                        if (filteredCitations.length > 0) {
                            showMessage(`‚úÖ ${filteredCitations.length} citation(s) s√©lectionn√©e(s) par l'IA`, 'info');
                            return filteredCitations.map((phrase, index) => {
                                let source = "Inconnu";
                                if (Array.isArray(candidates)) {
                                    const clean = s => s.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, '');
                                    const cleanPhrase = clean(phrase);

                                    // On cherche une correspondance sur les 60 premiers caract√®res
                                    const match = candidates.find(c => {
                                        const cleanC = clean(c.phrase);
                                        const part = 60;
                                        return cleanC.includes(cleanPhrase.substring(0, part)) ||
                                            cleanPhrase.includes(cleanC.substring(0, part));
                                    });
                                    if (match) source = match.source;
                                }

                                return {
                                    phrase: phrase,
                                    score: 100 - index,
                                    position: 0,
                                    source: source,
                                    aiGenerated: true,
                                    modelUsed: model.split('/')[1]
                                };
                            });
                        }
                    }

                    // Si pas de r√©sultat valide, essayer le mod√®le suivant
                    currentModelIndex++;
                    if (currentModelIndex < OPENROUTER_MODELS.length) {
                        await sleep(DELAY_BETWEEN_MODELS);
                    }

                } catch (error) {
                    console.error(`Erreur avec ${model}:`, error);
                    currentModelIndex++;

                    if (currentModelIndex < OPENROUTER_MODELS.length) {
                        await sleep(DELAY_AFTER_ERROR);
                    }
                }

                attempts++;
            }

            // Si tous les mod√®les √©chouent
            showMessage('‚ö†Ô∏è IA non disponible ou √©chec analyse', 'info');
            return [];
        }

        // Wrapper pour compatibilit√© avec le mode fichier local unique
        async function extractCitationsWithAI(text, keyword = '', numCitations = 5) {
            showMessage('ü§ñ Mode IA activ√© - Analyse du texte...', 'loading');

            // Extraction des candidats bruts
            const candidates = extractCitations(text, keyword, numCitations * 8);

            if (candidates.length === 0) {
                return [];
            }

            // Pr√©paration du texte
            const candidateTexts = candidates.map(c => c.phrase).join('\n---\n');

            // Appel √† la fonction centrale d'analyse
            const results = await runAIAnalysis(candidateTexts, keyword, numCitations);

            // Fallback si l'IA √©choue : on rend les candidats bruts
            if (results.length === 0) {
                return candidates.slice(0, numCitations);
            }

            return results;
        }

        async function callOpenRouterAPI(prompt, model) {
            // Construction du payload au format standard OpenRouter (Chat Completions)
            const payload = {
                model: model,
                messages: [
                    {
                        role: "user",
                        content: prompt
                    }
                ],
                temperature: 0.7,
                max_tokens: 2000
            };

            console.log('Payload envoy√© au proxy:', payload);

            try {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(API_TIMEOUT)
                });

                console.log('Statut r√©ponse:', response.status);

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('R√©ponse non JSON re√ßue:', responseText);
                    throw new Error(`R√©ponse invalide du serveur (${response.status})`);
                }

                if (!response.ok) {
                    console.error('Erreur API re√ßue:', data);
                    // Extraction du message d'erreur profond si disponible (format proxy HF)
                    let detailedError = "Erreur inconnue";
                    if (data.details) {
                        try {
                            const details = JSON.parse(data.details);
                            detailedError = details.error?.message || detailedError;
                        } catch (e) {
                            detailedError = data.details;
                        }
                    } else if (data.error) {
                        detailedError = typeof data.error === 'object' ? data.error.message : data.error;
                    }
                    throw new Error(`OpenRouter API error: ${detailedError}`);
                }

                console.log('Donn√©es re√ßues:', data);

                // Le proxy HuggingFace peut retourner directement le texte ou le format standard
                if (data.response) {
                    return data.response;
                }

                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                }

                if (data.output && data.output.choices) {
                    return data.output.choices[0].message.content;
                }

                throw new Error('Format de r√©ponse AI non reconnu');

            } catch (error) {
                if (error.name === 'TimeoutError') {
                    throw new Error('D√©lai d\'attente d√©pass√© (timeout)');
                }
                throw error;
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function displayCitations(citations, useAI = false) {
            citationsContainer.innerHTML = '';
            messageContainer.innerHTML = '';

            if (citations.length === 0) {
                return;
            }

            const keyword = keywordInput.value.trim();
            let message = `${citations.length} citation(s) trouv√©e(s)`;
            if (keyword) {
                message += ` avec paradoxe sur "${keyword}"`;
            }
            if (useAI) {
                message += ' (s√©lection IA)';
            }
            showMessage(message, 'info');

            citations.forEach((item, index) => {
                const citationDiv = document.createElement('div');
                citationDiv.className = 'citation';
                citationDiv.style.animationDelay = `${index * 0.1}s`;

                let pageNumber = '?';
                if (pageIndex.length > 0 && item.position) {
                    for (let page of pageIndex) {
                        if (item.position >= page.startChar && item.position <= page.endChar) {
                            pageNumber = page.pageNumber;
                            break;
                        }
                    }
                }

                const aiBadge = item.aiGenerated ? `<span class="ai-badge">IA: ${item.modelUsed || 'AI'}</span>` : '';

                citationDiv.innerHTML = `
                    <div class="citation-text">"${item.phrase}"</div>
                    <div class="citation-context">
                        ${item.source ? `<strong>${item.source}</strong> | ` : ''}
                        Citation ${index + 1}/${citations.length} ${aiBadge}
                        ${!item.aiGenerated ? `| Score: ${item.score} points` : ''}
                        ${pageIndex.length > 0 && pageNumber !== '?' ? ` | Page ${pageNumber}` : ''}
                    </div>
                `;

                citationsContainer.appendChild(citationDiv);
            });
        }

        function showMessage(text, type) {
            messageContainer.innerHTML = `<div class="${type}">${text}</div>`;
        }
    </script>
</body>

</html>